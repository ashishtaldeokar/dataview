<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
<script src="http:///maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.3/angular-sanitize.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/ng-csv/0.3.3/ng-csv.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

<body ng-app="csvApp">
  <br>
  <div ng-controller="csvController" class="container" ng-cloack>
    <h1>Export Leads Data to CSV file</h1>
    <button type="button" class="btn btn-default" ng-csv="data" filename="DATA.csv" csv-header="head" charset="utf-8"><span class="glyphicon glyphicon-download-alt">&nbsp;</span>Download CSV</button>
    <br>
    <div class="container">
  <h2><label>Search: <input ng-model="searchText"></label></h2>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Caller Name</th>
        <th>Patient Name</th>
        <th>Data added on</th>
        <th>Condition Type</th>
        <th>Condition Name</th>
        <th>SEC</th>
        <th>Lead added by</th>
        <th>Lead source</th>
        <th>Age</th>
        <th>Gender</th>
        <th>Location</th>
        <th>Mobile</th>
      </tr>
    </thead>
    <tbody>
      <tr ng-repeat = "lead in data | filter:searchText | orderBy:created">
        <td>{{lead.callerName}}</td>
        <td>{{lead.patientName}}</td>
        <td>{{lead.created}}</td>
        <td>{{lead.condition_type}}</td>
        <td>{{lead.condition_name}}</td>
        <td>{{lead.SEC}}</td>
        <td>{{lead.attendedBy}}</td>
        <td>{{lead.leadSource}}</td>
        <td>{{lead.age}}</td>
        <td>{{lead.gender}}</td>
        <td>{{lead.location}}</td>
        <td>{{lead.mobile}}</td>
      </tr>
    </tbody>
  </table>
</div>

</body>

    <br>
    <br>
  </div>
</body>
<style>
.table > tbody > tr:hover {
  background-color: #F2F2F2;
  cursor: pointer;
}
</style>
<script>
var app = angular.module("csvApp", ["ngSanitize","ngCsv"]);

app.controller("csvController", ["$scope","$http","$filter",
  function($scope,$http,$filter) {
    var header= [];
    var j = 0;
    $http.get("http://52.66.64.197:3000/api/leads").then(function(response){
      $scope.data = response.data;


      for(var i = 0; i < $scope.data.length ; i++)
      {
        if($scope.data[i]['condition'] == null)
          $scope.data[i]['condition'] == 'no data';
        j = 0;
        $scope.data[i]['condition_type'] = "no data";
        $scope.data[i]['condition_name'] = "no data";
        angular.forEach($scope.data[i],function(value,key){
          if(key == 'condition'){
            $scope.data[i].condition_type = value[0].type;
            $scope.data[i].condition_name = value[0].name;
          }
          if(key == 'created'){
            var d = new Date(value);
            $scope.data[i].created = $filter('date')(d, 'short');
          }

        });
        delete $scope.data[i].condition;

      }
      for(var i = 0 ; i < $scope.data.length; i++){
        j = 0;
        angular.forEach($scope.data[i],function(value,key){
          header[j] = key;
          j++;
        });
      }
      $scope.head = header;


    });


  }
]);
</script>
